#!/usr/bin/env python3
"""Insert 60 HbA1c dummy records for 30 users."""

import uuid
import json
import urllib.request

SUPABASE_URL = "https://josanlblwfjdaaezqbnw.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvc2FubGJsd2ZqZGFhZXpxYm53Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Nzg0MjYwNiwiZXhwIjoyMDgzNDE4NjA2fQ.JlTXBmY5HJAqfRD_AazsiBORpgLZfB74fPkNyyfVSQY"

# (user_id, recorded_at, value)
RECORDS = [
    # 高アクティブ（毎月：12月・1月・2月）— 10人×3回 = 30レコード
    ("b0000001-0000-0000-0000-000000000001", "2025-12", 7.2),
    ("b0000001-0000-0000-0000-000000000001", "2026-01", 7.0),
    ("b0000001-0000-0000-0000-000000000001", "2026-02", 6.8),
    ("b0000001-0000-0000-0000-000000000002", "2025-12", 8.4),
    ("b0000001-0000-0000-0000-000000000002", "2026-01", 7.8),
    ("b0000001-0000-0000-0000-000000000002", "2026-02", 7.3),
    ("b0000001-0000-0000-0000-000000000003", "2025-12", 6.5),
    ("b0000001-0000-0000-0000-000000000003", "2026-01", 6.4),
    ("b0000001-0000-0000-0000-000000000003", "2026-02", 6.5),
    ("b0000001-0000-0000-0000-000000000004", "2025-12", 9.1),
    ("b0000001-0000-0000-0000-000000000004", "2026-01", 8.5),
    ("b0000001-0000-0000-0000-000000000004", "2026-02", 8.1),
    ("b0000001-0000-0000-0000-000000000005", "2025-12", 5.8),
    ("b0000001-0000-0000-0000-000000000005", "2026-01", 5.9),
    ("b0000001-0000-0000-0000-000000000005", "2026-02", 5.7),
    ("b0000001-0000-0000-0000-000000000006", "2025-12", 7.5),
    ("b0000001-0000-0000-0000-000000000006", "2026-01", 7.4),
    ("b0000001-0000-0000-0000-000000000006", "2026-02", 7.3),
    ("b0000001-0000-0000-0000-000000000007", "2025-12", 8.0),
    ("b0000001-0000-0000-0000-000000000007", "2026-01", 7.5),
    ("b0000001-0000-0000-0000-000000000007", "2026-02", 7.1),
    ("b0000001-0000-0000-0000-000000000008", "2025-12", 6.2),
    ("b0000001-0000-0000-0000-000000000008", "2026-01", 6.1),
    ("b0000001-0000-0000-0000-000000000008", "2026-02", 6.0),
    ("b0000001-0000-0000-0000-000000000009", "2025-12", 7.8),
    ("b0000001-0000-0000-0000-000000000009", "2026-01", 7.6),
    ("b0000001-0000-0000-0000-000000000009", "2026-02", 7.5),
    ("2033ee1c-28b2-5187-8ba1-c94f7964e33e", "2025-12", 6.9),
    ("2033ee1c-28b2-5187-8ba1-c94f7964e33e", "2026-01", 6.7),
    ("2033ee1c-28b2-5187-8ba1-c94f7964e33e", "2026-02", 6.5),
    # 中アクティブ（2ヶ月に1回：12月・2月）— 10人×2回 = 20レコード
    ("b0000001-0000-0000-0000-000000000010", "2025-12", 7.4),
    ("b0000001-0000-0000-0000-000000000010", "2026-02", 7.1),
    ("b0000001-0000-0000-0000-000000000011", "2025-12", 8.2),
    ("b0000001-0000-0000-0000-000000000011", "2026-02", 7.7),
    ("b0000001-0000-0000-0000-000000000012", "2025-12", 6.3),
    ("b0000001-0000-0000-0000-000000000012", "2026-02", 6.2),
    ("b0000001-0000-0000-0000-000000000013", "2025-12", 7.9),
    ("b0000001-0000-0000-0000-000000000013", "2026-02", 7.5),
    ("b0000001-0000-0000-0000-000000000014", "2025-12", 5.6),
    ("b0000001-0000-0000-0000-000000000014", "2026-02", 5.7),
    ("b0000001-0000-0000-0000-000000000015", "2025-12", 8.6),
    ("b0000001-0000-0000-0000-000000000015", "2026-02", 8.0),
    ("b0000001-0000-0000-0000-000000000016", "2025-12", 7.0),
    ("b0000001-0000-0000-0000-000000000016", "2026-02", 6.8),
    ("b0000001-0000-0000-0000-000000000017", "2025-12", 6.8),
    ("b0000001-0000-0000-0000-000000000017", "2026-02", 6.6),
    ("b0000001-0000-0000-0000-000000000018", "2025-12", 9.0),
    ("b0000001-0000-0000-0000-000000000018", "2026-02", 8.3),
    ("b0000001-0000-0000-0000-000000000019", "2025-12", 7.2),
    ("b0000001-0000-0000-0000-000000000019", "2026-02", 7.0),
    # 低アクティブ（1回のみ）— 10人×1回 = 10レコード
    ("b0000001-0000-0000-0000-000000000020", "2025-12", 7.6),
    ("f0000001-0000-0000-0000-000000000001", "2026-01", 6.4),
    ("f0000001-0000-0000-0000-000000000002", "2025-12", 8.1),
    ("f0000001-0000-0000-0000-000000000003", "2026-02", 7.3),
    ("f0000001-0000-0000-0000-000000000004", "2025-12", 5.9),
    ("f0000001-0000-0000-0000-000000000005", "2026-01", 7.7),
    ("f0000001-0000-0000-0000-000000000006", "2025-12", 6.7),
    ("f0000001-0000-0000-0000-000000000008", "2026-02", 8.0),
    ("f0000001-0000-0000-0000-000000000009", "2025-12", 7.1),
    ("f0000001-0000-0000-0000-000000000010", "2026-01", 6.5),
]


def insert_batch(records, batch_num):
    url = f"{SUPABASE_URL}/rest/v1/hba1c_records"
    headers = {
        "apikey": SUPABASE_KEY,
        "Authorization": f"Bearer {SUPABASE_KEY}",
        "Content-Type": "application/json",
        "Prefer": "return=minimal",
    }
    data = json.dumps(records).encode("utf-8")
    req = urllib.request.Request(url, data=data, headers=headers, method="POST")
    try:
        with urllib.request.urlopen(req) as resp:
            print(f"  Batch {batch_num}: {resp.status} - {len(records)} records inserted")
            return True
    except urllib.error.HTTPError as e:
        print(f"  Batch {batch_num}: ERROR {e.code} - {e.read().decode()}")
        return False


def main():
    print(f"Inserting {len(RECORDS)} HbA1c records for 30 users\n")

    records = []
    for user_id, recorded_at, value in RECORDS:
        records.append({
            "id": str(uuid.uuid4()),
            "user_id": user_id,
            "recorded_at": f"{recorded_at}-01",
            "value": value,
            "is_public": True,
            "memo": None,
        })

    BATCH_SIZE = 50
    for i in range(0, len(records), BATCH_SIZE):
        batch = records[i:i+BATCH_SIZE]
        batch_num = i // BATCH_SIZE + 1
        if not insert_batch(batch, batch_num):
            print("STOPPING due to error")
            return

    print(f"\nAll {len(records)} HbA1c records inserted!")


if __name__ == "__main__":
    main()
